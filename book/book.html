<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link rel="stylesheet" type="text/css" href="../css/aui.2.0.css" />
    <link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css" />
    <style type="text/css">
        #header { position: fixed;z-index: 9999;}
        #header.transparent {background:transparent;box-shadow:none;}
        #header.transparent .aui-iconfont {color:#666666;}
        #main {margin-top:0;margin-bottom:0;padding-bottom: 55px;}
    #main .fengmian {margin:0;padding-top:2.8rem;padding-bottom:0.5rem;background:url("../image/booktop.png") center top no-repeat;background-size:cover;}
	#main .fengmian .aui-info, #main .fengmian .aui-info .aui-info-item {margin-top:0;margin-bottom:0;padding-top:0;padding-bottom:0;height:auto;min-height:auto;}
    #main .fengmian .aui-info {margin-top:0.3rem;margin-bottom:0.3rem;}
    #main .aui-info.book_name { width:95%;}
    #main .book_title { font-size: 1rem;color: #000;font-weight: 700;width:95%;overflow:hidden;white-space:normal;}
    #book_desco { position: relative; margin-top:0;padding:0.5rem;}
    #book_desco .rightdown { position: absolute;right: 5px;bottom: 0;z-index: 999; }
    .book_desco {height:3.1rem;overflow:hidden;text-overflow:ellipsis;}
    .divbutton { color: #00bcd4;font-size: 0.7rem;text-align: center;height: 2.2rem;line-height: 2.2rem;border-top: 1px solid #f5f6f7; }
    #footer {border-top: 1px solid #ddd;}
    #footer .aui-active { background: #03A9F4;}
    #footer .aui-active .fa, #footer .aui-active .aui-bar-tab-label {color: #fff;}
    .aui-col-xs-4 img { display: block;margin:0.2rem auto auto;}
    #main .aui-list::before, #main .aui-list::after { height: 0;display: none;}
    #main .aui-list .aui-list-item::after { background: #f5f6f7;}
    #main .aui-ellipsis-1 { display: inline-block;overflow: hidden;white-space: nowrap;text-oveflow:ellipsis;width: 90%;font-size: 0.6rem;}
    #main .relative { position: relative;}
    #main .starwarp { width: 80px;height: 15px;display: block;overflow: hidden;position: absolute;left: 0;}
    #main .starred, #main .starban { position: absolute;left: 0; }
     .starban { width: 100%; background: url("../image/icon/starban.png") no-repeat 0 0;z-index: 3;}
     .starred { width: 0;z-index:4;background: url("../image/icon/starred.png") no-repeat 0 0 transparent;}
    </style>
</head>
<body id="bookbody">
<header class="aui-bar aui-bar-nav transparent" id="header">
    <a class="aui-pull-left aui-btn" tapmode onclick="back()">
        <span class="aui-iconfont aui-icon-left"></span>
    </a>
    <div class="aui-title" id="title"></div>
    <a class="aui-pull-right aui-btn" tapmode onclick="share()">
        <span class="aui-iconfont aui-icon-share"></span>
    </a>
</header>
<div id="main">
    <div class="aui-row fengmian">
       <div class="aui-col-xs-4 aui-text-center"><img src="../image/book.png" style="width:90%" alt=""></div>
       <div class="aui-col-xs-8">
            <div class="aui-info">
                <div class="aui-info-item book_title"></div>
            </div>
            <div class="aui-info">
                <div class="aui-info-item aui-font-size-12">10分(100人评)</div>
            </div>
            <div class="aui-info">
                <div class="aui-info-item  aui-font-size-12">
                    <span class="aui-text-primary"></span>
                    <span class="aui-text-primary"> | </span>
                    <span class="aui-text-primary"></span>
                </div>
            </div>
            <div class="aui-info">
                <div class="aui-info-item  aui-font-size-12">共100章</div>
            </div>
            <div class="aui-info">
                <div class="aui-info-item"><div class="aui-list-item-title aui-text-warning  aui-font-size-12"></div></div>
            </div>
        </div>
    </div>
</div>
<script type="text/x-dot-template" id="main-temp">
    <div class="aui-row fengmian">
       <div class="aui-col-xs-4 aui-text-center">
        <img src="{{? it.image}}{{=indexSetting.url}}../data/attachment/forum/{{=it.image}}{{??}}../image/book.png{{?}}" style="width:90%;margin:0.3rem auto;" alt="">
       </div>
       <div class="aui-col-xs-8">
            <div class="aui-info book_name">
		        <div class="aui-info-item book_title">{{=it.book_name}}</div>
		    </div>
		    <div class="aui-info relative">
                <div class="starwarp">
                    <div class="starban">&nbsp;</div>
                    <div class="starred" style="width:{{=(it.scores * 10) || ''}}%">&nbsp;</div>
                </div>
		        <div class="aui-info-item aui-font-size-12" style="padding-left:85px">{{=it.scores}}分({{=it.dpcount}}人评)</div>
		    </div>
		    <div class="aui-info">
		        <div class="aui-info-item  aui-font-size-12">
		        	<span class="aui-text-default" tapmode onclick="openauthor({{=it.uid}},'{{=it.author}}')">{{=it.author}}</span>
                    <span class="aui-text-default">&nbsp;|&nbsp;</span>
                    <span class="aui-text-default" onclick="opencategory({{=it.category_id}},'{{=it.category_name}}')">{{=it.category_name}}</span>
		        </div>
		    </div>
		    <div class="aui-info">
		        <div class="aui-info-item  aui-font-size-12">共{{=it.colums}}章</div>
		    </div>
		    <div class="aui-info">
		        <div class="aui-info-item"><div class="aui-list-item-title aui-text-danger  aui-font-size-12">{{? it.price}}开通VIP优惠购买{{??}}免费图书{{?}}</div></div>
		    </div>
        </div>
    </div>
	{{? it.desco}}
    <p class="aui-font-size-12 aui-text-default book_desco " id="book_desco" onclick="showAll()">
        {{=it.desco || '没有简介'}}
        <i class="fa fa-sort-down rightdown fa-lg" id="book_desco_arrow"></i>
    </p>
    {{?}}
    <ul class="aui-list aui-list-in aui-margin-t-0 aui-margin-b-10">
        <li class="aui-list-item aui-list-item-middle" onclick="openmulu({{=it.book_id}},'{{=it.book_name}}',{{=it.uid}})">
            <div class="aui-list-item-inner aui-list-item-arrow">
                <div class="aui-list-item-title">查看目录</div>
                <div class="aui-list-item-right">
                    共{{=it.colums}}章
                </div>
            </div>
        </li>
    </ul>

    <div class="aui-row aui-margin-t-10 aui-margin-b-10">
        <div class="aui-col-xs-6">
            <ul class="aui-list aui-media-list">
                <li class="aui-list-item aui-list-item-middle" tapmode onclick="opendashang()">
                    <div class="aui-media-list-item-inner">
                        <div class="aui-list-item-media" style="width: 2rem;">
                            <i class="fa fa-2x aui-text-warning fa-gift"></i>
                        </div>
                        <div class="aui-list-item-inner ">
                            <div class="aui-list-item-text">
                                <div class="aui-list-item-title aui-font-size-14">打赏</div>
                                <div class="aui-list-item-right"></div>
                            </div>
                            <div class="aui-list-item-text  aui-ellipsis-1">
                                {{=it.dashangnums}}{{=indexSetting.dstrametitle}}
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div class="aui-col-xs-6">
            <ul class="aui-list aui-media-list">
                <li class="aui-list-item aui-list-item-middle" onclick="openfensi()">
                    <div class="aui-media-list-item-inner">
                        <div class="aui-list-item-media" style="width: 3rem;">
                            <i class="fa fa-2x aui-text-warning fa-thumbs-up"></i>
                        </div>
                        <div class="aui-list-item-inner ">
                            <div class="aui-list-item-text">
                                <div class="aui-list-item-title aui-font-size-14">粉丝</div>
                                <div class="aui-list-item-right"></div>
                            </div>
                            <div class="aui-list-item-text  aui-ellipsis-1">
                                共{{=it.fensinums}}粉丝
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>


    <ul class="aui-list aui-list-in aui-margin-b-0">
        <li class="aui-list-item aui-list-item-middle">
            <div class="aui-list-item-inner">
                <div class="aui-list-item-title">书评区</div>
                <div class="aui-list-item-right">
                    共{{=it.pinglunnums}}条评论
                </div>
            </div>
        </li>
    </ul>
    {{ for(var i=0,len=it.pinglun.length;i<len;i++) { }}
    <div class="aui-card-list aui-margin-b-0">
        <div class="aui-card-list-header aui-card-list-user aui-border-t">
            <div class="aui-card-list-user-avatar">
                <img src="{{=it.pinglun[i].avatar}}" class="aui-img-round" />
            </div>
            <div class="aui-card-list-user-name">
                <div>{{=it.pinglun[i].author}}</div>
            </div>
            <div class="aui-card-list-user-info"></div>
        </div>
        <div class="aui-card-list-content-padded">{{=it.pinglun[i].text}}</div>
        <div class="aui-card-list-footer">
            <div><i {{? indexSetting.dianping.indexOf(it.pinglun[i].dp_id)===-1}} onclick="dianping({{=it.pinglun[i].dp_id}},'zhichi')" {{?}} class="fa fa-thumbs-o-up" id="dpid_{{=it.pinglun[i].dp_id}}_zhichi">{{=it.pinglun[i].zhichi}}</i> </div>
            <div>
            <i {{? indexSetting.dianping.indexOf(it.pinglun[i].dp_id) === -1}} onclick="dianping({{=it.pinglun[i].dp_id}},'fandui')" {{?}} class="fa fa-thumbs-o-down" id="dpid_{{=it.pinglun[i].dp_id}}_fandui">{{=it.pinglun[i].fandui}}</i> 
            </div>
            <div><i class="fa "></i> {{=it.pinglun[i].time}}</div>
        </div>
    </div>
	{{ } }}
    <div class="divbutton" onclick="openshuping({{=it.book_id}})">去书评区发书评</div>

    <ul class="aui-list aui-media-list aui-margin-t-10 aui-margin-b-0" onclick="openauthor({{=it.uid}},'{{=it.author}}')">
        <li class="aui-list-item" style="box-shadow: none;margin-bottom: 0;">
           <div class="aui-media-list-item-inner">
            <div class="aui-list-item-inner ">作家主页</div>
           </div>
        </li>
        <li class="aui-list-item aui-list-item-middle" style="box-shadow: none;margin-bottom: 0;">
            <div class="aui-media-list-item-inner aui-list-item-arrow">
                <div class="aui-list-item-media" style="width: 3rem;">
                    <img src="{{=it.avatar}}" class="aui-img-round aui-list-img-sm">
                </div>
                <div class="aui-list-item-inner ">
                    <div class="aui-list-item-text">
                        <div class="aui-list-item-title aui-font-size-14">{{=it.author}}</div>
                        <div class="aui-list-item-right"></div>
                    </div>
                    <div class="aui-list-item-text">共创作图书{{=it.authorbooknums}}部</div>
                </div>
            </div>
        </li>
    </ul>
    {{? it.authorinfo}}
    <div class="aui-row">
        {{ for(var j=0,jlen=it.authorinfo.length;j<jlen;j++) { }}
        <div class="aui-col-xs-4">
            <div class="aui-text-center" onclick="openbook({{=it.authorinfo[j].book_id}})">
                <img src="{{? it.authorinfo[j].image}}{{=indexSetting.url}}../data/attachment/forum/{{=it.authorinfo[j].image}}{{??}}../image/book.png{{?}}" style="width:80%;" alt="">
                <span class="aui-text-default aui-ellipsis-1 ">{{=it.authorinfo[j].book_name}}</span>
            </div>
        </div>
        {{ } }}
    </div>
    {{?}}

    {{? it.other}}
    <ul class="aui-list aui-media-list aui-margin-t-10 aui-margin-b-0">
        <li class="aui-list-item" style="box-shadow: none;margin-bottom: 0;">
           <div class="aui-media-list-item-inner">
            <div class="aui-list-item-inner ">书友还读过</div>
           </div>
        </li>
    </ul>
    <div class="aui-row" id="huanyihuan">
        {{ for(var m=0,mlen=it.other.length;m<mlen;m++) { }}
        <div class="aui-col-xs-4">
            <div class="aui-text-center" onclick="openbook({{=it.other[m].book_id}})">
                <img src="{{? it.other[m].image}}{{=indexSetting.url}}../data/attachment/forum/{{=it.other[m].image}}{{??}}../image/book.png{{?}}" style="width:80%;" alt="">
                <span class="aui-text-default aui-ellipsis-1">{{=it.other[m].book_name}}</span>
            </div>
        </div>
        {{ } }}
    </div>
    <div class="divbutton aui-margin-b-15" onclick="randombook(this)"><span class=" fa fa-spinner fa-spin fa-fw aui-hide"></span>换一换</div>
    {{?}}
    <footer class="aui-bar aui-bar-tab whiteback" id="footer">
	    <div class="aui-bar-tab-item aui-hide" tapmode onclick="down({{=it.book_id}},0)">
	        <i class="aui-iconfont1 1aui-icon-star fa fa-arrow-circle-down"></i>
	        <div class="aui-bar-tab-label" id="downbutton">下载</div>
	    </div>
	    <div class="aui-bar-tab-item" tapmode onclick="addstore({{=it.book_id}},0)">
	        <i class="aui-iconfont1 1aui-icon-my fa fa-sign-in"></i>
	        <div class="aui-bar-tab-label" id="addstore">放入书架</div>
	    </div>
	    <div class="aui-bar-tab-item aui-active" tapmode onclick="read({{=it.book_id}},0)">
	        <i class="fa-book fa"></i>
	        <div class="aui-bar-tab-label" id="readbutton">阅读</div>
	    </div>
	    
        <div class="aui-bar-tab-item" tapmode onclick="langdu({{=indexSetting.book_id}},{{=indexSetting.firstcolumid}},'click')">
            <i class="fa fa-play-circle" id="bofangicon" data-play="init"></i>
            <div class="aui-bar-tab-label" id="langdu">听书</div>
        </div>
	</footer>
</script>
<script type="text/x-dot-template" id="huanyihuan-temp">
    {{ for(var m=0,mlen=it.books.length;m<mlen;m++) { }}
    <div class="aui-col-xs-4">
        <div class="aui-text-center" onclick="openbook({{=it.books[m].book_id}})">
            <img src="{{? it.books[m].image}}{{=indexSetting.url}}../data/attachment/forum/{{=it.books[m].image}}{{??}}../image/book.png{{?}}" style="width:80%;" alt="">
            <span class="aui-text-default aui-ellipsis-1">{{=it.books[m].book_name}}</span>
        </div>
    </div>
    {{ } }}
</script>
<div class="aui-tips aui-margin-b-15 aui-hide whiteback" id="nonetwork" style="position:fixed;bottom:50px;left: 0;right:0;z-index: 9999;">
    <i class="aui-iconfont aui-icon-info"></i>
    <div class="aui-tips-title">当前没有网络连接</div>
    <i class="aui-iconfont aui-icon-close" tapmode onclick="closeTips()"></i>
</div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/aui-scroll.js"></script>
<script type="text/javascript" src="../script/dot.js"></script>
<script type="text/javascript">
    var indexSetting = $api.getStorage('appinfo');
    
    var thebook = {};
    if($api.getStorage('localstore')){
        indexSetting.localstore = $api.getStorage('localstore');
    }else{
        indexSetting.localstore = {data:[]};
    }
    if($api.getStorage('dianping')){
        indexSetting.dianping = $api.getStorage('dianping');
    }else{
        indexSetting.dianping = [0];
    }
    if($api.getStorage('zhichi')){
        indexSetting.zhichi = $api.getStorage('zhichi');
    }else{
        indexSetting.zhichi = [0];
    }
    if($api.getStorage('fandui')){
        indexSetting.fandui = $api.getStorage('fandui');
    }else{
        indexSetting.fandui = [0];
    }
    var scroll = new auiScroll({
            listen:true,
            distance:50
        },function(ret){
        if(ret.scrollTop > 50){
            $api.removeCls($api.byId('header'),'transparent');
            $api.text($api.byId('title'),'书籍详情');
        }else{
            $api.addCls($api.byId('header'),'transparent');
            $api.text($api.byId('title'),'');
        }
    });
    apiready = function(){
        ajaxuser();
        $api.fixStatusBar( $api.dom('header') );
        api.parseTapmode();
        indexSetting.activity = api.require('UILoading');
        indexSetting.audio = api.require('audio');
        indexSetting.speechRecognizer = api.require('speechRecognizer');
        indexSetting.activity.keyFrame({
            rect: {
                w: 80,
                h: 80
            },
            styles: {
                bg: 'rgba(0,0,0,0.5)',
                corner: 15,
                interval: 50,
                frame: {
                    w: 80,
                    h: 80
                }
            }
        }, function(ret) {});
        indexSetting.book_id = api.pageParam.book_id?api.pageParam.book_id:0;
        api.addEventListener({
           name:'offline'
        }, function(ret, err){        
            $api.removeCls($api.byId('nonetwork'),'aui-hide');
        });
        api.addEventListener({
            name:'online'
        }, function(ret, err){
            closeTips();
        });
        indexSetting.fs = api.require('fs');
        if(api.connectionType == 'none'){
            $api.removeCls($api.byId('nonetwork'),'aui-hide');
            api.toast({
                msg: '没有网络',
                duration: 2000,
                location: 'top'
            });
        }else{
            ajaxuser();
            indexSetting.userinfo = $api.getStorage('userinfo');
            initload();
	        // 是否已下载
	        if(indexSetting.firstcolumid){
	            indexSetting.fs.exist({
	                path: 'fs://'+indexSetting.book_id+'_'+indexSetting.firstcolumid+'.txt'
	            },function(ret,err){
	                if( ret.exist ){
	                    $api.text($api.byId('downbutton'),'已下载');
	                }
	            });
	        }
        }
        if(isinstore(indexSetting.book_id)){
            $api.text($api.byId('addstore'),'已放入书架');
        }
        api.addEventListener({
		    name: 'keyback'
		}, function(ret, err) {
		    if(ret){
		    	back();
		    }
		});
		api.setRefreshHeaderInfo({
		    visible: true,
		    bgColor: '#ccc',
		    textColor: '#fff',
		    textDown: '下拉刷新...',
		    textUp: '松开刷新...',
		    showTime: true
		}, function(ret, err) {
	        $api.html($api.byId('indexlist'),'');
	        indexSetting.current =1;
	        indexSetting.total =2;
	        ajaxuser();
	        indexSetting.userinfo = $api.getStorage('userinfo');
			initload();
			api.refreshHeaderLoadDone()
		});
    };

    function closeTips(){
        $api.addCls($api.byId('nonetwork'),'aui-hide');
    }
    function isinstore(book_id){
        if(indexSetting.localstore && $api.isArray(indexSetting.localstore.data) ){
            for(var i=0,len=indexSetting.localstore.data.length;i<len;i++){
                if(indexSetting.localstore.data[i].book_id==book_id){
                    return true;
                }
            }
            return false;
        }else{
            return false;
        }
    }
    function isinhistory(book_id){
        if(indexSetting.history && $api.isArray(indexSetting.history.data) && indexSetting.history.data.length){
            for(var i=0,len=indexSetting.history.data.length;i<len;i++){
                if(indexSetting.history.data[i].book_id==book_id){
                    return true;
                }
            }
            return false;
        }else{
            return false;
        }
    }
	//  初始化 
    function initload(){
        indexSetting.userinfo = $api.getStorage('userinfo');
    	api.ajax({
		    url: indexSetting.url+'api.php?appkey='+indexSetting.appkey+'&type=get&module=book&param=book_id----'+indexSetting.book_id+',bbsuid----'+indexSetting.userinfo.bbsuid,
		    method: 'get'
		}, function(ret, err) {
		    if (ret) {
		    	if(ret.status){
                    indexSetting.colums = ret.colums;
                    indexSetting.firstcolumid = indexSetting.shoundcid = ret.firstcolumid;
                    indexSetting.shoundprogress = 0;
                    indexSetting.firstsubject = indexSetting.shoundsubject = ret.firstsubject;
                    indexSetting.zhangjie = indexSetting.shoundzhangjie= ret.firstzhangjie;
                    indexSetting.firstkedu = ret.firstkedu;
                    indexSetting.firstprice = indexSetting.shoundprice = ret.firstprice;
                    
                    var newhistory = {};
                    newhistory.image = ret.image;
                    newhistory.book_name = ret.book_name;
                    newhistory.book_id = ret.book_id;
                    newhistory.colums = ret.colums;
                    newhistory.zhangjie = ret.firstzhangjie;
                    newhistory.colum_id = ret.firstcolumid;
                    newhistory.subject = ret.firstsubject;
                    newhistory.progress = 0;
                    if($api.getStorage('history')){
                        indexSetting.history = $api.getStorage('history');
                        if(!isinhistory(indexSetting.book_id)){
                            indexSetting.history.data.unshift(newhistory)
                            $api.setStorage('history',indexSetting.history);
                        }else{
                        	//当前图书已有在历史中
                        	var tmphistory = $api.getStorage('history');
				             for(var i=0,len=tmphistory.data.length;i<len;i++){
				             	if(tmphistory.data[i].book_id == indexSetting.book_id){
				             		 indexSetting.shoundcid = tmphistory.data[i].colum_id;
                    				 indexSetting.shoundprogress = tmphistory.data[i].progress;
                    				 indexSetting.shoundsubject = tmphistory.data[i].subject;
                    				 indexSetting.shoundzhangjie = tmphistory.data[i].zhangjie;
                    				 indexSetting.shoundprice = tmphistory.data[i].price;
				             	}
				             }
                        }
                    }else{
                        indexSetting.history = {data:[newhistory]}
                        $api.setStorage('history',indexSetting.history);
                    }
                    thebook.book_id = ret.book_id;
                    thebook.authorid = ret.uid;
                    thebook.colums = ret.colums;
                    thebook.book_name = ret.book_name;
                    thebook.image = ret.image;
                    thebook.desco = ret.desco;
                    thebook.author = ret.author;
                    thebook.category_name = ret.category_name;
                    thebook.scores = ret.scores;
                    thebook.avatar = ret.avatar;
                    thebook.authorbooknums = ret.authorbooknums;
                    thebook.fensinums = ret.fensinums;
                    thebook.dashangnums = ret.dashangnums;
                    thebook.authorinfo = $api.jsonToStr(ret.authorinfo);
                	var temp = $api.text($api.byId("main-temp"));
                	var dottemp = doT.template(temp);
                	var html = dottemp(ret);
                	$api.html($api.byId('main'),html);
                    setTimeout(function(){
                        for(var k=0,klen=ret.pinglun.length;k<klen;k++){
                            if(indexSetting.dianping.indexOf(parseInt(ret.pinglun[k].dp_id)) != -1){
                                if(indexSetting.zhichi.indexOf(parseInt(ret.pinglun[k].dp_id)) != -1){
                                    $api.addCls($api.byId('dpid_'+ret.pinglun[k].dp_id+'_zhichi'),'aui-text-danger');
                                }else if(indexSetting.fandui.indexOf(parseInt(ret.pinglun[k].dp_id)) != -1){
                                    $api.addCls($api.byId('dpid_'+ret.pinglun[k].dp_id+'_fandui'),'aui-text-danger');
                                }
                            }
                        }
                    },300);
                    if(indexSetting.firstcolumid){
                        indexSetting.fs.exist({
                            path: 'fs://'+indexSetting.book_id+'_'+indexSetting.firstcolumid+'.txt'
                        },function(ret,err){
                            if( ret.exist ){
                                $api.text($api.byId('downbutton'),'已下载');
                            }
                        });
                    }
                    if(isinstore(indexSetting.book_id)){
                        $api.text($api.byId('addstore'),'已加入书架');
                    }
                    
                }else{
                	api.toast({
				        msg: ret.error,
				        duration: 2000,
				        location: 'top'
				    });
                }
		        indexSetting.activity.closeKeyFrame();
            } else {
                api.toast({
                    msg: err.msg,
                    duration: 2000,
                    location: 'top'
                });
                indexSetting.activity.closeKeyFrame();
            }
		});
    }
    function showAll () {
        $api.toggleCls($api.byId('book_desco'),'book_desco');
        $api.toggleCls($api.byId('book_desco_arrow'),'fa-flip-vertical');
    }
//打开分类
function opencategory(category_id,category_name){
    api.openWin({
        name: 'category',
        url: './category.html',
        rect: {
            x: 0,
            y: 0,
            w: api.winWidth,
            h: api.winHeight
        },
        pageParam: {
            category_id:category_id,
            category_name:category_name
        },
        bgColor:"#F5F5F5",
        bounces: true,
        vScrollBarEnabled: true,
        hScrollBarEnabled: false,
        animation:{
            type:"push",
            subType:"from_right",
            duration:300
        },
        reload:true
    });
}
//打开书评
function openshuping(book_id){
	api.openWin({
        name: 'shuping',
        url: './shuping.html',
        rect: {
            x: 0,
            y: 0,
            w: api.winWidth,
            h: api.winHeight
        },
        pageParam: {
            book_id:indexSetting.book_id,
            book_name:thebook.book_name
        },
        bgColor:"#F5F5F5",
        bounces: true,
        vScrollBarEnabled: true,
        hScrollBarEnabled: false,
        animation:{
            type:"push",
            subType:"from_right",
            duration:300
        },
        reload:true
    });
}

//换一换
function randombook(tag){
    $api.removeCls($api.dom(tag,'.fa'),'aui-hide');
    api.ajax({
        url: indexSetting.url+'api.php?appkey='+indexSetting.appkey+'&type=get&module=hyih',
        method: 'get'
    }, function(ret, err) {
        if(ret.books.length){
            var temp = $api.text($api.byId("huanyihuan-temp"));
            var dottemp = doT.template(temp);
            var html = dottemp(ret);
            $api.html($api.byId('huanyihuan'),html);
        }
        $api.addCls($api.dom(tag,'.fa'),'aui-hide');
    });
}
//打开目录
function openmulu(book_id,book_name,authorid){
	if(parseInt(indexSetting.colums) < 1){
		api.toast({
            msg: '暂无章节',
            duration: 2000,
            location: 'top'
        });
		return;
	}
    api.openWin({
        name: 'mulu',
        url: './mulu.html',
        rect: {
            x: 0,
            y: 0,
            w: api.winWidth,
            h: api.winHeight
        },
        pageParam: {
            book_id: book_id,
            book_name:book_name,
            authorid:authorid
        },
        bgColor:"#F5F5F5",
        bounces: false,
        vScrollBarEnabled: true,
        hScrollBarEnabled: false,
        animation:{
            type:"push",
            subType:"from_right",
            duration:300
        },
        reload:true
    });
}
//打开粉丝榜
function openfensi(){
    api.openWin({
        name: 'fensi',
        url: './fensi.html',
        rect: {
            x: 0,
            y: 0,
            w: api.winWidth,
            h: api.winHeight
        },
        pageParam: {
            authorid:thebook.authorid,
            book_id:thebook.book_id,
            book_name:thebook.book_name,
            author:thebook.author,
            avatar:thebook.avatar,
            authorinfo:thebook.authorinfo,
            fensinums:thebook.fensinums,
            authorbooknums:thebook.authorbooknums
        },
        bgColor:"#F5F5F5",
        bounces: false,
        vScrollBarEnabled: true,
        hScrollBarEnabled: false,
        animation:{
            type:"push",
            subType:"from_right",
            duration:300
        },
        reload:true
    });
}

//加入书架
function addstore(book_id,uid){
    // 待同步服务器
    if(!isinstore(book_id)){
        if($api.getStorage('localstore')){
            indexSetting.localstore = $api.getStorage('localstore');
            indexSetting.localstore.data.push(thebook)
            $api.setStorage('localstore',indexSetting.localstore);
        }else{
            indexSetting.localstore = {data:[thebook]}
            $api.setStorage('localstore',indexSetting.localstore);
        }
        var userinfo = $api.getStorage('userinfo');
        if(userinfo.bbsuid && userinfo.bbsuid > 0){
            api.ajax({
                url: indexSetting.url+'api.php?appkey='+indexSetting.appkey+'&type=get&module=addstore&param=book_id----'+indexSetting.book_id+',bbsuid----'+userinfo.bbsuid,
                method: 'get'
            }, function(ret, err) {if (ret) {}});
        }
        $api.text($api.byId('addstore'),'已加入书架');
        api.execScript({
		   name: 'root',
		   frameName: 'store',
		   script: 'api.refreshHeaderLoading()'
		});
    }else{
        $api.text($api.byId('addstore'),'已加入书架');
    }
}
//下载
function down(book_id,uid){
    if(indexSetting.colums < 1){
        api.toast({
            msg: '暂无章节',
            duration: 2000,
            location: 'top'
        });
        indexSetting.download = false;
        return false;
    }
    $api.html($api.byId('downbutton'),'<i class="fa fa-spinner fa-spin"></i>');
    api.download({
        url: indexSetting.url+'api.php?appkey='+indexSetting.appkey+'&type=get&module=downbook&param=book_id----'+book_id+',colum_id----'+indexSetting.firstcolumid,
        savePath: 'fs://'+book_id+'_'+indexSetting.firstcolumid+'.txt',
        report: true,
        cache: true,
        allowResume: true
    }, function(ret, err) {
        if (ret.state == 1) {
            $api.html($api.byId('downbutton'),'已下载');
            indexSetting.download = true;
        } else if(ret.state==2){
            api.toast({
                msg: '下载失败',
                duration: 2000,
                location: 'top'
            });
            $api.html($api.byId('downbutton'),'下载');
            indexSetting.download = false;
            return false;
        }
    });
}
//阅读
var downintval;
function read(book_id,uid){
    if( parseInt(indexSetting.colums) < 1){
        api.toast({
            msg: '暂无章节',
            duration: 2000,
            location: 'top'
        });
        return;
    }
    indexSetting.userinfo = $api.getStorage('userinfo');
    if(indexSetting.firstprice > 0){
        if(indexSetting.userinfo.bbsuid < 1){
            // 未登录或未绑定论坛帐号,提醒登录或绑定
            tixinglogin();
            return false;
        }else if(!indexSetting.firstkedu){
            // 不可读，未购买 提醒购买
            tixinggoumai('read');
            return false;
        }
    }
    indexSetting.download = 1;
    $api.text($api.byId('readbutton'),'打开中..');
    indexSetting.fs.exist({
        path: 'fs://'+book_id+'_'+indexSetting.firstcolumid+'.txt'
    },function(ret,err){
        if(!ret.exist){
            down(book_id,uid);
        }else{
            indexSetting.download = true;
        }
    });
    downintval = setInterval(function(){
        if(indexSetting.download !== 1){
            clearInterval(downintval);
            checkdownload(book_id);
        }
    },500);
}

function checkdownload(book_id){
    indexSetting.fs.getAttribute({
		    path: 'fs://'+indexSetting.book_id+'_'+indexSetting.firstcolumid+'.txt'
		}, function(ret, err) {
		    if (ret.status) {
		        if(ret.attribute.size > 1){
		        	indexSetting.download = true;
		        }else{
		        	indexSetting.download = false;
		        }
		    } else {
		        indexSetting.download = false;
		    }
		});
    if(indexSetting.download === true){
    	$api.text($api.byId('readbutton'),'阅读');
         api.openWin({
             name: 'read',
             url: './read.html',
             rect: {
                 x: 0,
                 y: 0,
                 w: api.winWidth,
                 h: api.winHeight
             },
             pageParam: {
                 book_id: book_id,
                 book_name:thebook.book_name,
                 image:thebook.image,
                 desco:thebook.desco,
                 colum_id:indexSetting.shoundcid,
                 zhangjie:indexSetting.shoundzhangjie,
                 subject:indexSetting.shoundsubject,
                 price:indexSetting.shoundprice,
                 authorid:thebook.authorid,
                 progress:indexSetting.shoundprogress
             },
             bgColor:"#F5F5F5",
             bounces: false,
             vScrollBarEnabled: true,
             hScrollBarEnabled: false,
             animation:{
                 type:"push",
                 subType:"from_right",
                 duration:300
             },
             reload:true
         });    
     }else{
        api.toast({
             msg: '暂无章节',
             duration: 2000,
             location: 'top'
         });
        $api.text($api.byId('readbutton'),'阅读');
         return;
     }
}
//朗读
function langdu(book_id,colum_id,eventtype){
    if(eventtype=='click'){
        var dqzhuangtai = $api.attr($api.byId('bofangicon'),'data-play');
        if(dqzhuangtai == 'init'){
            if(!indexSetting.firstcolumid){
            	nozhangjie();
            	return;
            }
        	//当前是初始化状态，点击播放,
        	$api.attr($api.byId('bofangicon'),'data-play','playing');
        	$api.addCls($api.byId('bofangicon'), 'fa-spin');
        	api.toast({
    		     msg: '即将朗读，可回到到桌面，但不可退出本页',
    		     duration: 5000,
    		     location: 'top'
    		});
        }else if(dqzhuangtai == 'playing'){
        //进行暂停操作
        	$api.attr($api.byId('bofangicon'),'data-play','zanting');
        	$api.removeCls($api.byId('bofangicon'), 'fa-spin');
        	indexSetting.speechRecognizer.pauseRead();
        	return false;
        }else if(dqzhuangtai == 'zanting'){
        	//恢复播放
        	$api.attr($api.byId('bofangicon'),'data-play','playing');
        	$api.addCls($api.byId('bofangicon'), 'fa-spin');
        	indexSetting.speechRecognizer.resumeRead();
        	return false;
        }
    }
    indexSetting.startaudio = 0;
    var size = 0;
    indexSetting.strarray = new Array();
	if(colum_id){
		api.download({
	        url: indexSetting.url+'api.php?appkey='+indexSetting.appkey+'&type=get&module=downbook&param=book_id----'+book_id+',colum_id----'+colum_id,
	        savePath: 'fs://'+book_id+'_'+colum_id+'.txt',
	        report: true,
	        cache: true,
	        allowResume: true
	    }, function(ret, err) {
	        if (ret.state == 1) {
	        	indexSetting.fssy = api.require('fs');
				var retsy = indexSetting.fssy.openSync({
				    path: 'fs://'+book_id+'_'+colum_id+'.txt',
				    flags: 'read_write'
				});
				if(!retsy.status){
					opentxtshibai();
					return;
				}
				var retsyAttr = indexSetting.fssy.getAttributeSync({
				    path: 'fs://'+book_id+'_'+colum_id+'.txt'
				});
				size = retsyAttr.attribute.size;
				if(size > 1){
				   indexSetting.fenduan = Math.ceil(size/1000);
				    var tmp = indexSetting.fssy.readSync({fd:retsy.fd,offset:(indexSetting.startaudio*1000),length:1000,codingType:'utf8'});
				    if(tmp.data){
				   		indexSetting.startaudio++;
				   		readstrinaudio(tmp.data,book_id,colum_id);
				    }else{
					   	//下一个章节
					   		api.ajax({
									url: indexSetting.url+'api.php?appkey='+indexSetting.appkey+'&type=get&module=nextcolum&param=book_id----'+book_id+',colum_id----'+colum_id+',zhangjie----'+indexSetting.zhangjie,
									method: 'get'
								}, function(retnext, errnext) {
								if(parseInt(retnext.data.colum_id) < 1){
								   api.toast({
								          msg: '没有了',
								          duration: 2000,
								          location: 'top'
								    });
								    indexSetting.speechRecognizer.pauseRead();
								}else{
								    indexSetting.zhangjie = retnext.data.zhangjie;
								    langdu(book_id,retnext.data.colum_id,0);
								    return;
								}
							});
					   }
				 }else{
				   	nozhangjie();
				 }        	
	        }else if(ret.state==2){
	        	nozhangjie();
	        }
	    });
	}else{
		nozhangjie();
	}
}
function readstrinaudio(str,book_id,colum_id){
	indexSetting.speechRecognizer.read({
		readStr: str,
		speed: 80,
		volume: 100,
		voice: 'vixq',
		rate: 16000
	}, function(ret, err) {
		if (ret.status) {
			if(ret.speakProgress==100){
				var tmp = indexSetting.fssy.readSync({offset:(indexSetting.startaudio*1000),length:1000,codingType:'utf8'});
				if(tmp.data){
					indexSetting.startaudio++;
					readstrinaudio(tmp.data);
				}else{
					api.ajax({
						url: indexSetting.url+'api.php?appkey='+indexSetting.appkey+'&type=get&module=nextcolum&param=book_id----'+book_id+',colum_id----'+colum_id+',zhangjie----'+indexSetting.zhangjie,
							method: 'get'
						}, function(retnext, errnext) {
						if(parseInt(retnext.data.colum_id) < 1){
						    api.toast({
						        msg: '没有了',
						        duration: 2000,
						        location: 'top'
						    });
						    indexSetting.speechRecognizer.stopRead();
						}else{
						    indexSetting.zhangjie = retnext.data.zhangjie;
						    langdu(book_id,retnext.data.colum_id,0);
						}  
					});
				}
			}
		}
	});
}

function tixinglogin(){
    indexSetting.userinfo = $api.getStorage('userinfo');
    // 只有在付费章节才进行判断
    if(indexSetting.firstprice){
        // 是付费章节才进行登录判断
        if(!$api.trim(indexSetting.userinfo.uid) || ($api.trim(indexSetting.userinfo.uid) =='0')){
            msg = '登录';
            type = 'login';
        }else if(parseInt(indexSetting.userinfo.bbsuid) < 1){
            msg = '绑定';
            type = 'userinfo';
        }
        // 未在登录且绑定状态则进行提醒
        if(!$api.trim(indexSetting.userinfo.uid) || (parseInt(indexSetting.userinfo.bbsuid) < 1)){
            var dialogBox = api.require('dialogBox');
            dialogBox.alert({
                texts: {
                    title: '请'+msg,
                    content: 'VIP章节'+msg+'后才可以阅读哦！',
                    leftBtnTitle: '取消',
                    rightBtnTitle: '去'+msg
                },
                styles: {
                    bg: '#f5f5f5',
                    w: 300,
                    corner:5,
                    
                    title: {
                        marginT: 20,
                        icon: 'widget://image/login.png',
                        iconSize: 40,
                        titleSize: 14,
                        titleColor: '#e51c23'
                    },
                    content: {
                        color: '#000',
                        size: 14
                    },
                    left: {
                        marginB: 7,
                        marginL: 20,
                        w: 130,
                        h: 35,
                        corner: 2,
                        bg: '#e51c23',
                        color:"#ffffff",
                        size: 12
                    },
                    right: {
                        marginB: 7,
                        marginL: 10,
                        w: 130,
                        h: 35,
                        corner: 2,
                        bg: '#009688',
                        size: 12,
                        color:"#ffffff"
                    }
                }
            }, function(ret) {
                if (ret.eventType == 'right') {
                    api.openWin({
                        name: type,
                        url: './'+type+'.html',
                        progress:{
                            type:"page"
                        },
                        pageParam:{
                            from:"book",
                            book_id:indexSetting.book_id
                        },
                        reload:true,
                        bgColor:"#F5F5F5",
                        bounces: true,
                        vScrollBarEnabled: true,
                        hScrollBarEnabled: false  ,
                        animation:{
                            type:"push",
                            subType:"from_right",
                            duration:300
                        }
                    });
                }
                var dialogBox = api.require('dialogBox');
                    dialogBox.close({
                        dialogName: 'alert'
                });
            });
        }
    }
}

function tixinggoumai (readtype) {
	ajaxuser();
    var userinfo = $api.getStorage('userinfo');
    if(userinfo.tramenums < indexSetting.firstprice){
        // 金钱不足，需充值
        var dialogBox = api.require('dialogBox');
        dialogBox.alert({
                texts: {
                    title: '请充值',
                    content: '你的'+indexSetting.trametitle+'不足，请充值后购买本章节！',
                    leftBtnTitle: '取消',
                    rightBtnTitle: '去充值'
                },
                styles: {
                    bg: '#f5f5f5',
                    w: 300,
                    corner:5,
                    
                    title: {
                        marginT: 20,
                        icon: 'widget://image/chongzhi.png',
                        iconSize: 40,
                        titleSize: 14,
                        titleColor: '#e51c23'
                    },
                    content: {
                        color: '#000',
                        size: 14
                    },
                    left: {
                        marginB: 7,
                        marginL: 20,
                        w: 130,
                        h: 35,
                        corner: 2,
                        bg: '#e51c23',
                        color:"#ffffff",
                        size: 12
                    },
                    right: {
                        marginB: 7,
                        marginL: 10,
                        w: 130,
                        h: 35,
                        corner: 2,
                        bg: '#009688',
                        size: 12,
                        color:"#ffffff"
                    }
                }
            }, function(ret) {
                if (ret.eventType == 'right') {
                    alert('客户端暂未开通充值功能，请去PC端充值');
                }
                var dialogBox = api.require('dialogBox');
                    dialogBox.close({
                        dialogName: 'alert'
                });
            });
    }else{
        // 确认购买
        var dialogBox = api.require('dialogBox');
        dialogBox.alert({
                texts: {
                    title: '购买VIP章节',
                    content: '本章价格'+indexSetting.firstprice+indexSetting.trametitle+'！',
                    leftBtnTitle: '取消',
                    rightBtnTitle: '购买'
                },
                styles: {
                    bg: '#f5f5f5',
                    w: 300,
                    corner:5,
                    
                    title: {
                        marginT: 20,
                        icon: 'widget://image/chongzhi.png',
                        iconSize: 40,
                        titleSize: 14,
                        titleColor: '#e51c23'
                    },
                    content: {
                        color: '#000',
                        size: 14
                    },
                    left: {
                        marginB: 7,
                        marginL: 20,
                        w: 130,
                        h: 35,
                        corner: 2,
                        bg: '#e51c23',
                        color:"#ffffff",
                        size: 12
                    },
                    right: {
                        marginB: 7,
                        marginL: 10,
                        w: 130,
                        h: 35,
                        corner: 2,
                        bg: '#009688',
                        size: 12,
                        color:"#ffffff"
                    }
                }
            }, function(ret) {
                if (ret.eventType == 'right') {
                    var bbsuid = userinfo.bbsuid;
                    var authorid = thebook.authorid;
                    var price = indexSetting.firstprice;
                    var book_id = thebook.book_id;
                    var colum_id = indexSetting.firstcolumid;
                    api.ajax({
                        url: indexSetting.url+'api.php?appkey='+indexSetting.appkey+'&type=get&module=buytid&param=bbsuid----'+bbsuid+',book_id----'+book_id+',authorid----'+authorid+',price----'+price+',colum_id----'+colum_id,
                        method: 'get'
                    }, function(ret2, err2) {
                        if(ret2.status){
                                api.toast({
                                    msg: '购买成功',
                                    duration: 2000,
                                    location: 'top'
                                });
                                // 继续阅读或朗读
                                indexSetting.firstkedu = 1;
                                var dialogBox = api.require('dialogBox');
                                dialogBox.close({
                                   dialogName: 'alert'
                                });
                                if(readtype == 'read'){
                                    read(thebook.book_id,userinfo.bbsuid);
                                }
                        }else{
                                api.toast({
                                    msg: '购买失败',
                                    duration: 2000,
                                    location: 'top'
                                });
                            var dialogBox = api.require('dialogBox');
                            dialogBox.close({
                               dialogName: 'alert'
                            });
                        }
                    });
                }else{
                    var dialogBox = api.require('dialogBox');
                        dialogBox.close({
                            dialogName: 'alert'
                    });
                }
            });
    }
}

function nozhangjie(){
	api.toast({
        msg: '暂无章节',
        duration: 2000,
        location: 'top'
    });
}
function opentxtshibai(){
	api.toast({
             msg: '播放失败',
             duration: 2000,
             location: 'top'
    });
}
// 进入打赏页面
function opendashang(){
    api.openWin({
        name: 'dashang',
        url: './dashang.html',
        rect: {
            x: 0,
            y: 0,
            w: api.winWidth,
            h: api.winHeight
        },
        pageParam: {
            authorid:thebook.authorid,
            book_id:thebook.book_id,
            book_name:thebook.book_name,
            author:thebook.author,
            avatar:thebook.avatar,
            dashangnums:thebook.dashangnums
        },
        bgColor:"#F5F5F5",
        bounces: false,
        vScrollBarEnabled: true,
        hScrollBarEnabled: false,
        animation:{
            type:"push",
            subType:"from_right",
            duration:300
        },
        reload:true
    });
}

function share(){
    var dialogBox = api.require('dialogBox');
    dialogBox.actionMenu ({
        rect:{
            h: 150
        },
        texts:{
             cancel: '取消'
        },
        items:[
        {
            text: 'QQ',
            icon: 'widget://image/icon/qq.png'
        },
        {
            text: 'QZone',
            icon: 'widget://image/icon/qzone.png'
        },{
            text: '微信',
            icon: 'widget://image/icon/wechat.png'
        },
        {
            text: '朋友圈',
            icon: 'widget://image/icon/quan.png'
        }
        ],
        styles:{
            bg:'#FFF',
            column: 4,
            itemText: {
                color: '#000',
                size: 12,
                marginT:8
            },
            itemIcon:{
                size:40
            },
            cancel:{  
                bg: '#ffffff',   
                color:'#000',          
                h: 44 ,                 
                size: 14       
            }
        }
    }, function(ret){
    	if(ret.index < 2){
    		var qq = api.require('qq');
				qq.shareNews({
				    url: indexSetting.url+'../plugin.php?id=jameson_read&contrl=touch&act=book&book_id='+indexSetting.book_id+'&laiyuan=app',
				    title: thebook.book_name,
				    description: thebook.desco?thebook.desco:' ',
				    type:(ret.index>0?'QZone':'QFriend'),
				    imgUrl: indexSetting.url+'../'+(thebook.image?('data/attachment/forum/'+thebook.image):'source/plugin/jameson_read/images/book.jpg')
				},function(retqq,errqq){
					if(retqq.status){
						api.toast({
				             msg: '分享成功',
				             duration: 2000,
				             location: 'top'
				         });
					}else if(errqq.code != -4){
						api.toast({
				             msg: '系统异常或未安装qq',
				             duration: 2000,
				             location: 'top'
				         });
					}
				});
    	}else if(ret.index < 4){
    		var wx = api.require('wx');
			wx.shareWebpage({
			    scene: (ret.index == 3?'timeline':'session'),
			    title: thebook.book_name,
			    description: thebook.desco?thebook.desco:'来自西风云阅读的好书！',
			    thumb: 'widget://image/book.png',
			    contentUrl: indexSetting.url+'../plugin.php?id=jameson_read&contrl=touch&act=book&book_id='+indexSetting.book_id+'&laiyuan=app'
			}, function(retwx, errwx) {
			    if (retwx.status) {
			        api.toast({
				       msg: '分享成功',
				       duration: 2000,
				       location: 'top'
				     });
			    } else {
			    	if(errwx.code !=2){
			    		api.toast({
					       msg: '授权被拒绝或未安装微信',
					       duration: 2000,
					       location: 'top'
					     });
			    	}
			    }
			});
    	}
        dialogBox.close ({
            dialogName: 'actionMenu'
        });
        
    });
}
</script>
</html>